name: Gerar DMG macOS com gibMacOS

on:
  workflow_dispatch:

jobs:
  build-installer:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v3

      - name: Instalar dependências
        run: brew install python3 p7zip

      - name: Clonar gibMacOS
        run: git clone https://github.com/corpnewt/gibMacOS.git gibMacOS

      - name: Baixar via gibMacOS (publicrelease)
        working-directory: gibMacOS
        run: |
          echo publicrelease > catalog.txt
          python3 gibMacOS.command --publicrelease --nobuild

      - name: Executar BuildmacOSInstallApp
        working-directory: gibMacOS
        run: |
          open BuildmacOSInstallApp.command
          # aguardar até que o InstallAssistant.app seja instalado
          sleep 60

      - name: Confirmar app instalado
        run: ls /Applications | grep "Install macOS"

      - name: Criar DMG instalador
        run: |
          APP=$(ls /Applications | grep "Install macOS" | head -n1)
          hdiutil create -o installer_raw -size 16000m -volname Installer -layout SPUD -fs HFS+J
          hdiutil attach installer_raw.dmg -noverify -mountpoint /Volumes/installer
          sudo "/Applications/${APP}/Contents/Resources/createinstallmedia" --volume /Volumes/installer --nointeraction
          sudo hdiutil detach /Volumes/installer
          hdiutil convert installer_raw.dmg -format UDZO -o installer.dmg

      - name: Criar release com DMG
        uses: softprops/action-gh-release@v1
        with:
          files: installer.dmg
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
