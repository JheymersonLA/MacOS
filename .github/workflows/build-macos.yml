name: Build macOS Installer DMG

on:
  push:
    branches: main

jobs:
  build:
    runs-on: macos-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Restore .pkg from cache
      id: cache-pkg
      uses: actions/cache@v4
      with:
        path: /tmp/InstallAssistant.pkg
        key: macos-installer-pkg-cache

    - name: Download InstallAssistant.pkg (if not in cache)
      if: steps.cache-pkg.outputs.cache-hit != 'true'
      run: |
        curl -L -o /tmp/InstallAssistant.pkg "https://swcdn.apple.com/content/downloads/63/15/032-41630-A_MQYCM6C3K5/6slbdsvie6fqzv63fn9gafz2h44a26ru4s/InstallAssistant.pkg"

    - name: Expand .pkg
      run: |
        pkgutil --expand-full /tmp/InstallAssistant.pkg /tmp/installer-expanded
        mkdir -p /Applications
        installer -pkg /tmp/installer-expanded/InstallAssistant.pkg -target /

    - name: Verificar existência do .app
      run: |
        if [ ! -d "/Applications/Install macOS Sequoia.app" ]; then
          echo "Erro: Install macOS Sequoia.app não encontrado em /Applications"
          exit 1
        fi

    - name: Montar SharedSupport.dmg
      run: |
        hdiutil attach "/Applications/Install macOS Sequoia.app/Contents/SharedSupport/SharedSupport.dmg"

    - name: Criar DMG comprimido
      run: |
        mkdir -p output
        hdiutil create -volname "Install macOS Sequoia" -srcfolder "/Volumes/Shared Support" -format UDZO output/Install_macOS_Sequoia.dmg

    - name: Upload para Release
      uses: softprops/action-gh-release@v2
      with:
        files: output/Install_macOS_Sequoia.dmg
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
