name: Criar DMG do macOS Installer

on:
  push:
    branches:
      - master

jobs:
  build:
    runs-on: macos-latest

    steps:
      - name: Restaurar cache do InstallAssistant.pkg
        uses: actions/cache@v3
        id: cache-pkg
        with:
          path: /tmp/InstallAssistant.pkg
          key: install-assistant-pkg-v1

      - name: Baixar InstallAssistant.pkg (se necessário)
        if: steps.cache-pkg.outputs.cache-hit != 'true'
        run: |
          echo "Baixando InstallAssistant.pkg..."
          curl -L -o /tmp/InstallAssistant.pkg "https://swcdn.apple.com/content/downloads/51/28/082-44432-A_4NJSZXK8G5/v10fo5dlwd50fja3qbnhj7z9tp1dx41vq2/InstallAssistant.pkg"

      - name: Instalar o InstallAssistant.pkg
        run: |
          sudo installer -pkg /tmp/InstallAssistant.pkg -target /

      - name: Encontrar caminho do Install macOS.app
        id: find-app
        run: |
          APP_PATH=$(find /Applications -maxdepth 1 -type d -name "Install macOS*.app" | head -n 1)
          if [ -z "$APP_PATH" ]; then
            echo "Install macOS.app não encontrado!"
            exit 1
          fi
          echo "APP_PATH=$APP_PATH" >> $GITHUB_ENV
          echo "Encontrado: $APP_PATH"

      - name: Montar SharedSupport.dmg
        run: |
          SHARED_SUPPORT="$APP_PATH/Contents/SharedSupport/SharedSupport.dmg"
          if [ ! -f "$SHARED_SUPPORT" ]; then
            echo "SharedSupport.dmg não encontrado em $SHARED_SUPPORT"
            exit 1
          fi
          hdiutil attach "$SHARED_SUPPORT"

      - name: Criar DMG a partir do volume montado
        run: |
          MOUNTED_VOLUME=$(mount | grep "Shared Support" | awk '{print $3}')
          if [ -z "$MOUNTED_VOLUME" ]; then
            echo "Volume 'Shared Support' não montado!"
            exit 1
          fi
          mkdir -p output
          hdiutil create -volname "Install macOS" -srcfolder "$MOUNTED_VOLUME" -format UDZO output/Install_macOS.dmg

      - name: Fazer upload do DMG como artefato
        uses: actions/upload-artifact@v4
        with:
          name: Install_macOS
          path: output/Install_macOS.dmg

      - name: Criar release e enviar DMG
        uses: softprops/action-gh-release@v2
        with:
          files: output/Install_macOS.dmg
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
