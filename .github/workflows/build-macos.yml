name: Criar DMG do macOS Installer

on:
  push:
    branches:
      - master

jobs:
  build:
    runs-on: macos-latest

    steps:
      # --- CACHE ---
      - name: Restaurar cache
        uses: actions/cache@v3
        id: cache-pkg
        with:
          path: /tmp/InstallAssistant.pkg
          key: installassistant-${{ github.sha }}

      # --- DOWNLOAD ---
      - name: Baixar InstallAssistant.pkg
        if: steps.cache-pkg.outputs.cache-hit != 'true'
        run: |
          curl -L -o /tmp/InstallAssistant.pkg \
            "https://swcdn.apple.com/content/downloads/51/28/082-44432-A_4NJSZXK8G5/v10fo5dlwd50fja3qbnhj7z9tp1dx41vq2/InstallAssistant.pkg" \
            --progress-bar
        timeout-minutes: 30

      # --- INSTALAÇÃO ---
      - name: Instalar InstallAssistant.pkg
        run: |
          sudo installer -pkg /tmp/InstallAssistant.pkg -target / -verbose

      # --- LOCALIZAR APP ---
      - name: Encontrar app de instalação
        id: find-app
        run: |
          APP_PATH=$(find /Applications -maxdepth 1 -name "Install macOS*.app" -print -quit)
          [ -z "$APP_PATH" ] && { echo "::error::App não encontrado"; exit 1; }
          echo "APP_PATH=${APP_PATH}" >> $GITHUB_ENV
          echo "App encontrado: ${APP_PATH}"

      # --- MONTAGEM SEGURA ---
      - name: Montar SharedSupport.dmg com permissões
        run: |
          # Desmontar se já existir
          hdiutil eject "/Volumes/SharedSupport" -force 2>/dev/null || true
          
          # Montar com permissões explícitas
          sudo hdiutil attach \
            "$APP_PATH/Contents/SharedSupport/SharedSupport.dmg" \
            -mountpoint "/Volumes/SharedSupport" \
            -nobrowse \
            -noverify \
            -noautoopen \
            -owners on \
            -verbose

          # Ajustar permissões
          sudo chown -R runner:staff "/Volumes/SharedSupport"
          sudo chmod -R 755 "/Volumes/SharedSupport"

      # --- CRIAÇÃO DO DMG ---
      - name: Criar DMG com autenticação
        run: |
          echo "⏳ Iniciando criação do DMG (pode demorar vários minutos)..."
          
          # Criar como root para evitar problemas de permissão
          sudo hdiutil create \
            -volname "Install macOS" \
            -srcfolder "/Volumes/SharedSupport" \
            -format UDZO \
            -ov \
            -scrub \
            -fs HFS+ \
            -uid 0 \
            -gid 80 \
            -megabytes 16000 \
            "$GITHUB_WORKSPACE/output/Install_macOS.dmg" \
            -verbose

          # Ajustar dono do arquivo final
          sudo chown runner:staff "$GITHUB_WORKSPACE/output/Install_macOS.dmg"

          echo "✅ DMG criado com sucesso!"

      # --- LIMPEZA ---
      - name: Ejetar volume
        run: |
          hdiutil eject "/Volumes/SharedSupport" -force || true

      # --- PUBLICAÇÃO ---
      - name: Upload do artefato
        uses: actions/upload-artifact@v4
        with:
          name: Install_macOS
          path: output/Install_macOS.dmg