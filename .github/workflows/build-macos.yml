name: Create macOS .dmg from Install macOS.app

on:
  push:
    branches:
      - master

jobs:
  build:
    runs-on: macos-latest

    steps:
    - name: Check out repository
      uses: actions/checkout@v2

    - name: Verificar cache do InstallAssistant.pkg
      uses: actions/cache@v3
      with:
        path: /tmp/InstallAssistant.pkg
        key: install-assistant-pkg-${{ runner.os }}-${{ hashFiles('InstallAssistant.pkg') }}
        restore-keys: |
          install-assistant-pkg-${{ runner.os }}-

    - name: Baixar InstallAssistant.pkg se não encontrado no cache
      run: |
        if [ ! -f /tmp/InstallAssistant.pkg ]; then
          curl -L -o /tmp/InstallAssistant.pkg "https://swcdn.apple.com/content/downloads/51/28/082-44432-A_4NJSZXK8G5/v10fo5dlwd50fja3qbnhj7z9tp1dx41vq2/InstallAssistant.pkg"
        fi

    - name: Instalar o InstallAssistant.pkg
      run: |
        # Instalar o pacote .pkg no diretório /Applications
        sudo installer -pkg /tmp/InstallAssistant.pkg -target /

    - name: Verificar se o Install macOS.app foi instalado
      run: |
        if [ ! -d /Applications/Install\ macOS.app ]; then
          echo "Erro: Install macOS.app não encontrado em /Applications"
          exit 1
        fi

    - name: Criar um .dmg a partir do Install macOS.app
      run: |
        # Criar uma imagem de disco (dmg) a partir do .app
        hdiutil create -volname "Install macOS" -srcfolder "/Applications/Install macOS.app" -ov -format UDZO /tmp/Install\ macOS.dmg

    - name: Criar um Release no GitHub
      uses: actions/create-release@v1
      with:
        tag_name: v1.0.0
        release_name: "Release do macOS Install"
        body: "Release contendo o Install macOS em formato .dmg"
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Upload do arquivo .dmg para o Release
      uses: actions/upload-artifact@v4
      with:
        name: Install-macOS-dmg
        path: /tmp/Install\ macOS.dmg

    # Não apagar o arquivo .pkg do cache para reutilização nas próximas execuções
    - name: Limpeza de arquivos temporários não essenciais
      run: |
        # Apagar o arquivo .dmg após o upload, mas manter o .pkg no cache
        rm -f /tmp/Install\ macOS.dmg
