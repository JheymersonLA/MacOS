name: Gerar DMG macOS com gibMacOS

on:
  push:
    branches:
      - main  # Isso faz com que o workflow rode automaticamente toda vez que houver um commit na branch 'main'
  workflow_dispatch:  # Ainda permite a execução manual, se necessário

jobs:
  build-installer:
    runs-on: macos-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Instalar dependências e criar ambiente virtual
        run: |
          brew install python3
          python3 -m venv venv
          source venv/bin/activate
          sudo pip install --upgrade pip
          sudo pip install xattr
        shell: bash

      - name: Baixar script installinstallmacos.py
        run: |
          source venv/bin/activate
          curl -L -o installinstallmacos.py https://raw.githubusercontent.com/munki/macadmin-scripts/main/installinstallmacos.py

      - name: Baixar instalador macOS (última versão pública)
        run: |
          source venv/bin/activate
          python3 installinstallmacos.py

      - name: Encontrar InstallAssistant.pkg
        run: |
          PKG=$(find . -name "InstallAssistant*.pkg" | head -n1)
          echo "PKG_PATH=$PKG" >> $GITHUB_ENV

      - name: Extrair InstallAssistant.pkg
        run: |
          mkdir installer
          sudo pkgutil --expand-full "$PKG_PATH" installer/

      - name: Localizar e copiar .app
        run: |
          APP=$(find installer -type d -name "Install macOS *.app" | head -n1)
          echo "APP_PATH=$APP" >> $GITHUB_ENV
          sudo cp -R "$APP" /Applications/

      - name: Criar DMG instalador
        run: |
          APP_PATH="${{ env.APP_PATH }}"
          sudo hdiutil create -o installer_raw -size 16000m -volname Installer -layout SPUD -fs HFS+J
          sudo hdiutil attach installer_raw.dmg -noverify -mountpoint /Volumes/installer
          sudo "/Applications/$(basename "$APP_PATH")/Contents/Resources/createinstallmedia" --volume /Volumes/installer --nointeraction
          sudo hdiutil detach /Volumes/installer
          sudo hdiutil convert installer_raw.dmg -format UDZO -o installer.dmg

      - name: Criar release com DMG
        uses: softprops/action-gh-release@v1
        with:
          files: installer.dmg
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
