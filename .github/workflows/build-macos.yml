name: Gerar DMG macOS com gibMacOS

on:
  workflow_dispatch:

jobs:
  build-installer:
    runs-on: macos-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Instalar dependências
        run: |
          brew install python3
          python3 -m pip install --upgrade pip
          pip3 install xattr

      - name: Baixar script installinstallmacos.py
        run: |
          curl -L -o installinstallmacos.py https://raw.githubusercontent.com/munki/macadmin-scripts/main/installinstallmacos.py

      - name: Baixar instalador macOS (última versão pública)
        run: |
          python3 installinstallmacos.py --auto --no-verify

      - name: Encontrar InstallAssistant.pkg
        run: |
          PKG=$(find . -name "InstallAssistant*.pkg" | head -n1)
          echo "PKG_PATH=$PKG" >> $GITHUB_ENV

      - name: Extrair InstallAssistant.pkg
        run: |
          mkdir installer
          pkgutil --expand-full "$PKG_PATH" installer/

      - name: Localizar e copiar .app
        run: |
          APP=$(find installer -type d -name "Install macOS *.app" | head -n1)
          echo "APP_PATH=$APP" >> $GITHUB_ENV
          sudo cp -R "$APP" /Applications/

      - name: Criar DMG instalador
        run: |
          hdiutil create -o installer_raw -size 16000m -volname Installer -layout SPUD -fs HFS+J
          hdiutil attach installer_raw.dmg -noverify -mountpoint /Volumes/installer
          sudo /Applications/"$(basename "$APP_PATH")"/Contents/Resources/createinstallmedia --volume /Volumes/installer --nointeraction
          sudo hdiutil detach /Volumes/installer
          hdiutil convert installer_raw.dmg -format UDZO -o installer.dmg

      - name: Criar release com DMG
        uses: softprops/action-gh-release@v1
        with:
          files: installer.dmg
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
